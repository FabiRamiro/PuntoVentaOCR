<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<VBox xmlns="http://javafx.com/javafx/11.0.1" xmlns:fx="http://javafx.com/fxml/1" fx:controller="com.pos.puntoventaocr.controllers.NuevaVentaController" prefWidth="1000.0" prefHeight="700.0">
   <children>
      <!-- Título -->
      <HBox alignment="CENTER_LEFT" style="-fx-background-color: #f8f9fa; -fx-padding: 15;" prefHeight="60.0">
         <children>
            <Label style="-fx-font-size: 20px; -fx-font-weight: bold;" text="Nueva Venta" />
            <Region HBox.hgrow="ALWAYS" />
            <Label fx:id="lblNumeroVenta" style="-fx-font-size: 16px; -fx-font-weight: bold;" text="Venta #: [Número]" />
         </children>
      </HBox>

      <!-- Contenido principal -->
      <SplitPane dividerPositions="0.65" VBox.vgrow="ALWAYS" prefHeight="580.0">
         <items>
            <!-- Panel izquierdo: Productos y carrito -->
            <VBox spacing="10.0" style="-fx-padding: 10;">
               <children>
                  <!-- Búsqueda de productos -->
                  <VBox spacing="5.0">
                     <children>
                        <Label style="-fx-font-weight: bold;" text="Buscar Producto" />
                        <HBox spacing="10.0">
                           <children>
                              <TextField fx:id="txtBuscarProducto" prefWidth="350.0" prefHeight="30.0" promptText="Código de barras, nombre o código interno..." />
                              <Button fx:id="btnBuscarProducto" onAction="#buscarProducto" prefHeight="30.0" text="Buscar" />
                              <Button fx:id="btnEscanearCodigo" onAction="#escanearCodigo" prefHeight="30.0" text="Escáner" />
                           </children>
                        </HBox>
                     </children>
                  </VBox>

                  <!-- Lista de productos encontrados -->
                  <VBox spacing="5.0">
                     <children>
                        <Label style="-fx-font-weight: bold;" text="Productos Disponibles" />
                        <TableView fx:id="tablaProductosDisponibles" prefHeight="180.0">
                           <columns>
                              <TableColumn fx:id="colCodigoDisponible" prefWidth="120.0" text="Código" />
                              <TableColumn fx:id="colNombreDisponible" prefWidth="250.0" text="Nombre" />
                              <TableColumn fx:id="colPrecioDisponible" prefWidth="100.0" text="Precio" />
                              <TableColumn fx:id="colStockDisponible" prefWidth="80.0" text="Stock" />
                              <TableColumn fx:id="colAccionDisponible" prefWidth="80.0" text="Acción" />
                           </columns>
                        </TableView>
                     </children>
                  </VBox>

                  <!-- Carrito de compras -->
                  <VBox spacing="5.0" VBox.vgrow="ALWAYS">
                     <children>
                        <HBox alignment="CENTER_LEFT" spacing="10.0">
                           <children>
                              <Label style="-fx-font-weight: bold;" text="Carrito de Compras" />
                              <Region HBox.hgrow="ALWAYS" />
                              <Button fx:id="btnLimpiarCarrito" onAction="#limpiarCarrito" style="-fx-background-color: #dc3545; -fx-text-fill: white;" text="Limpiar Carrito" />
                           </children>
                        </HBox>

                        <TableView fx:id="tablaCarrito" VBox.vgrow="ALWAYS" minHeight="250.0">
                           <columns>
                              <TableColumn fx:id="colCodigoCarrito" prefWidth="100.0" text="Código" />
                              <TableColumn fx:id="colNombreCarrito" prefWidth="200.0" text="Producto" />
                              <TableColumn fx:id="colCantidadCarrito" prefWidth="80.0" text="Cantidad" />
                              <TableColumn fx:id="colPrecioCarrito" prefWidth="100.0" text="Precio" />
                              <TableColumn fx:id="colSubtotalCarrito" prefWidth="120.0" text="Subtotal" />
                              <TableColumn fx:id="colAccionesCarrito" prefWidth="80.0" text="Acciones" />
                           </columns>
                        </TableView>
                     </children>
                  </VBox>
               </children>
            </VBox>

            <!-- Panel derecho: Resumen y pago -->
            <ScrollPane fitToWidth="true" prefWidth="350.0">
               <content>
                  <VBox spacing="15.0" style="-fx-background-color: #f8f9fa; -fx-padding: 20;">
                     <children>
                        <!-- Resumen de la venta -->
                        <VBox spacing="10.0">
                           <children>
                              <Label style="-fx-font-weight: bold; -fx-font-size: 14px;" text="Resumen de Venta" />

                              <GridPane hgap="10.0" vgap="8.0">
                                 <columnConstraints>
                                    <ColumnConstraints hgrow="NEVER" minWidth="100.0" />
                                    <ColumnConstraints hgrow="ALWAYS" />
                                 </columnConstraints>

                                 <children>
                                    <Label text="Artículos:" GridPane.columnIndex="0" GridPane.rowIndex="0" />
                                    <Label fx:id="lblCantidadArticulos" style="-fx-font-weight: bold;" text="0" GridPane.columnIndex="1" GridPane.rowIndex="0" />

                                    <Label text="Subtotal:" GridPane.columnIndex="0" GridPane.rowIndex="1" />
                                    <Label fx:id="lblSubtotal" style="-fx-font-weight: bold;" text="0.00" GridPane.columnIndex="1" GridPane.rowIndex="1" />

                                    <Label text="IVA (16%):" GridPane.columnIndex="0" GridPane.rowIndex="2" />
                                    <Label fx:id="lblIVA" style="-fx-font-weight: bold;" text="0.00" GridPane.columnIndex="1" GridPane.rowIndex="2" />

                                    <Separator GridPane.columnIndex="0" GridPane.columnSpan="2" GridPane.rowIndex="3" />

                                    <Label style="-fx-font-size: 16px; -fx-font-weight: bold;" text="TOTAL:" GridPane.columnIndex="0" GridPane.rowIndex="4" />
                                    <Label fx:id="lblTotal" style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #28a745;" text="0.00" GridPane.columnIndex="1" GridPane.rowIndex="4" />
                                 </children>
                              </GridPane>
                           </children>
                        </VBox>

                        <Separator />

                        <!-- Método de pago -->
                        <VBox spacing="10.0">
                           <children>
                              <Label style="-fx-font-weight: bold; -fx-font-size: 14px;" text="Método de Pago" />

                              <VBox spacing="8.0">
                                 <children>
                                    <RadioButton fx:id="rbEfectivo" selected="true" text="Efectivo">
                                       <toggleGroup>
                                          <ToggleGroup fx:id="grupoMetodoPago" />
                                       </toggleGroup>
                                    </RadioButton>
                                    <RadioButton fx:id="rbTarjeta" text="Tarjeta" toggleGroup="$grupoMetodoPago" />
                                    <RadioButton fx:id="rbTransferencia" text="Transferencia" toggleGroup="$grupoMetodoPago" />
                                 </children>
                              </VBox>

                              <!-- Panel de efectivo -->
                              <VBox fx:id="panelEfectivo" spacing="5.0">
                                 <children>
                                    <Label text="Pago con efectivo:" />
                                    <TextField fx:id="txtPagoEfectivo" promptText="Cantidad recibida..." />
                                    <Label fx:id="lblCambio" style="-fx-font-weight: bold;" text="Cambio: 0.00" />
                                 </children>
                              </VBox>

                              <!-- Panel de transferencia -->
                              <VBox fx:id="panelTransferencia" spacing="5.0" visible="false" managed="false">
                                 <children>
                                    <Label text="Se abrirá el módulo OCR para validar" />
                                    <Label text="el comprobante de transferencia automáticamente." />
                                    <Button fx:id="btnValidarTransferencia" text="Validar Comprobante con OCR" style="-fx-background-color: #17a2b8; -fx-text-fill: white;" onAction="#abrirModuloOCR" />
                                 </children>
                              </VBox>
                           </children>
                        </VBox>

                        <Separator />

                        <!-- Acciones de venta -->
                        <VBox spacing="15.0">
                           <children>
                              <Button fx:id="btnProcesarVenta" onAction="#procesarVenta" maxWidth="Infinity" style="-fx-background-color: #28a745; -fx-text-fill: white; -fx-font-size: 16px; -fx-font-weight: bold; -fx-padding: 15;" text="PROCESAR VENTA" disable="true" />

                              <!-- Eliminar el HBox que contenía btnGuardarPendiente y cambiar por un solo botón -->
                              <Button fx:id="btnCancelarVenta" onAction="#cancelarVenta" maxWidth="Infinity" style="-fx-background-color: #6c757d; -fx-text-fill: white;" text="Cancelar Venta" />

                              <Button fx:id="btnImprimirTicket" onAction="#imprimirTicket" maxWidth="Infinity" text="Imprimir Ticket" visible="false" />
                           </children>
                        </VBox>
                     </children>
                  </VBox>
               </content>
            </ScrollPane>
         </items>
      </SplitPane>

      <!-- Barra de estado -->
      <ToolBar style="-fx-background-color: #e9ecef;" prefHeight="40.0">
         <items>
            <Label fx:id="lblEstadoVenta" text="Listo para nueva venta" />
            <Separator orientation="VERTICAL" />
            <Label fx:id="lblUsuarioVendedor" text="Vendedor: [Usuario]" />
            <Region HBox.hgrow="ALWAYS" />
            <Label fx:id="lblFechaHoraVenta" text="[Fecha y Hora]" />
         </items>
      </ToolBar>
   </children>
</VBox>
